# モデル仕様書

## 概要

AeroCast Engineは、天気情報を取得し、データ化、予測の回答を行うシステムです。
本ドキュメントでは、システム内で使用される各モデルとアルゴリズムの仕様を説明します。

---

## 1. 雪確率推定モデル (`snow_estimator.py`)

### 1.1 概要

降水確率と気温から雪確率を推定する簡易モデルです。
気温が低いほど雪の確率が高くなるという仮定に基づいています。

### 1.2 モデル仕様

**関数**: `estimate_snow_probability(pop: int, temp_c: float) -> int`

**パラメータ**:
- `pop`: 降水確率（%）
- `temp_c`: 気温（℃）

**出力**: 推定された雪確率（%）

### 1.3 アルゴリズム

```
if pop <= 0:
    return 0
if temp_c <= 0.0:
    return pop  # 100%
if temp_c < 2.0:
    return pop * 0.7  # 70%
if temp_c < 4.0:
    return pop * 0.3  # 30%
return 0  # 0%
```

### 1.4 仮定と制約

- **仮定**: 気温が低いほど、降水が雪になる確率が高い
- **制約**: 
  - 気温のみを考慮（湿度、気圧などは考慮しない）
  - 地域特性を考慮しない（全国一律のモデル）
  - 季節変動を考慮しない

### 1.5 バージョン

- **v1.0** (現在): 基本的な気温ベースの推定

---

## 2. 意図解析モデル (`intent_parser.py`)

### 2.1 概要

ユーザーの自然言語入力から、天気情報の取得意図を抽出するモデルです。
ルールベースのアプローチを使用しています。

### 2.2 抽出項目

- **都市名**: トリガーワードとノイズワードを除去して抽出
- **日数**: 時間表現（今日、明日など）から抽出（0-5日）

### 2.3 トリガーワード

- "天気", "予報", "雨", "気温", "暑い", "寒い"

### 2.4 制約

- 天気関連のトリガーワードが含まれていない場合は解析失敗
- 日数が0-5の範囲外の場合は解析失敗
- 都市名が抽出できない場合は解析失敗

---

## 3. 判断ルール (`rules.py`)

### 3.1 傘の判断 (`decide_umbrella`)

**閾値**: `RAIN_UMBRELLA_THRESHOLD = 40%`

- 降水確率 >= 40%: 傘が必要
- 降水確率 < 40%: 傘は不要

**根拠**: 一般的に降水確率40%以上で傘を持参することが推奨される

### 3.2 風速の判断 (`decide_wind`)

**閾値**: `WIND_ALERT_THRESHOLD = 10 m/s`

- 風速 >= 10 m/s: 注意が必要
- 風速 < 10 m/s: 問題なし

**根拠**: 気象庁の強風注意報基準（10 m/s以上）を参考

### 3.3 快適度の判断 (`decide_comfort`)

**分類**:
- `HOT`: 体感温度 >= 30℃
- `WARM`: 20℃ <= 体感温度 < 30℃
- `COOL`: 10℃ <= 体感温度 < 20℃
- `COLD`: 体感温度 < 10℃

**根拠**: 一般的な体感温度の分類

---

## 4. LLMフォーマッター (`formatter.py`)

### 4.1 概要

天気情報を自然な日本語で説明するために、OpenAI GPT-4o-miniを使用します。

### 4.2 プロンプト設計

**システムプロンプト**:
```
あなたは天気情報を分かりやすく説明するアシスタントです。
与えられた情報をそのまま説明してください。
新しい判断や推測は行わないでください。
```

### 4.3 パラメータ

- **モデル**: `gpt-4o-mini`
- **Temperature**: `0.3` (一貫性を重視)

### 4.4 バリデーション

LLM出力に対して、判断・推測・推奨表現が含まれていないか検証します。
禁止表現が検出された場合は、フォールバックフォーマッターを使用します。

---

## 5. データモデル (`models.py`)

### 5.1 WeatherResult

天気情報の事実データを格納します。

**主要フィールド**:
- `city`: 都市名
- `weather`: 天気の説明
- `temp`: 気温（℃）
- `feels_like`: 体感温度（℃）
- `rain_probability`: 降水確率（%）
- `snow_probability`: 雪確率（%）
- `wind_speed`: 風速（m/s）

### 5.2 WeatherContext

天気情報と判断結果を組み合わせたコンテキストです。

**構成**:
- `weather`: WeatherResult
- `umbrella`: UmbrellaDecision
- `wind`: WindDecision
- `comfort`: ComfortDecision

---

## 6. 評価指標

### 6.1 意図解析の精度

- **精度**: 正しく解析できたケース数 / 全ケース数
- **評価データ**: `tests/data/benth_cases.jsonl`

### 6.2 システムの可用性

- **成功率**: エラーなく完了したリクエスト数 / 全リクエスト数
- **エラー率**: エラーが発生したリクエスト数 / 全リクエスト数

### 6.3 LLM出力の品質

- **バリデーション通過率**: バリデーションを通過した出力数 / 全出力数
- **フォールバック使用率**: フォールバックが使用された回数 / 全リクエスト数

---

## 7. 今後の改善予定

1. **雪確率推定モデルの改善**
   - 機械学習モデルの導入
   - 地域特性の考慮
   - 季節変動の考慮

2. **意図解析の改善**
   - LLMベースの意図解析への移行
   - より柔軟な都市名認識

3. **判断ルールの最適化**
   - ユーザーフィードバックに基づく閾値調整
   - 個人差の考慮
